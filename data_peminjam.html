<!DOCTYPE html>
<html>
<head>
  <title>Inventaris Barang</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page">
  <div class="crm-shell">
    <aside class="crm-sidebar">
      <a class="crm-brand crm-brand__link" href="index.html">
        <img src="image/LogoIPB.png" alt="Logo IPB">
        <div>
          <h2>Inventory CRM</h2>
          <span>Lab Komputer</span>
        </div>
      </a>
      <nav class="crm-nav">
        <a class="crm-nav__link" href="dashboard.html">Beranda</a>
        <a class="crm-nav__link" href="data_barang.html">Data Barang</a>
        <a class="crm-nav__link active" href="data_peminjam.html">Data Peminjam</a>
        <a class="crm-nav__link" href="pinjam_alat.html">Peminjaman</a>
        <a class="crm-nav__link" href="chart.html">Laporan</a>
        <a class="crm-nav__link" href="tentang_kami.html">Tentang Kami</a>
      </nav></aside>

    <main class="crm-main">
      <header class="crm-topbar">
        <div>
          <h1>Data Peminjam</h1>
          <p>Kelola data mahasiswa atau dosen berdasarkan NIM/NID.</p>
        </div>
        <div class="crm-topbar__actions">
          <button class="btn btn-primary" id="openAddPeminjam">Tambah Peminjam</button>
          <div class="crm-user">
            <span>Hi, <strong id="username">-</strong> (<button type="button" class="crm-user__logout" onclick="window.app.logout()">Logout</button>)</span>
          </div>
        </div>
      </header>

      <section class="crm-panel">
        <table id="peminjamTable" class="table table-hover table-striped table-modern">
        <thead>
          <tr>
            <th scope="col" align="left">NIM/NID</th>
            <th scope="col" align="left">Nama</th>
            <th scope="col" align="left">Prodi</th>
            <th scope="col" align="left">Nomor Telepon</th>
            <th scope="col" align="left">Aksi</th>
          </tr>
        </thead>
        <tbody id="peminjamBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <div class="crm-modal" id="peminjamModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3 id="peminjamModalTitle">Input Peminjam</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div id="peminjamModalAlert"></div>
      <form id="peminjamModalForm">
        <input type="hidden" name="no" id="modalNo">
        <div class="form-group">
          <label>NIM/NID</label>
          <input type="text" name="nim" id="modalNim" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Nama</label>
          <input type="text" name="nama" id="modalNama" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Prodi</label>
          <input type="text" name="prodi" id="modalProdi" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Nomor Telepon</label>
          <input type="text" name="telepon" id="modalTelepon" class="form-control" required>
        </div>
        <div class="crm-modal__actions">
          <button type="button" class="btn btn-light" data-close>Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="app.js"></script>
  <script>
    window.app.requireAuth();
    (async () => {
      try {
        const data = await window.app.apiJson('/api/me');
        document.getElementById('username').textContent = data.username || '';
      } catch {
        document.getElementById('username').textContent = '';
      }
    })();

    const peminjamModal = document.getElementById('peminjamModal');
    const peminjamModalAlert = document.getElementById('peminjamModalAlert');
    const peminjamModalTitle = document.getElementById('peminjamModalTitle');
    const peminjamModalForm = document.getElementById('peminjamModalForm');
    const modalNo = document.getElementById('modalNo');

    function openPeminjamModal(mode, data = {}) {
      peminjamModalAlert.innerHTML = '';
      peminjamModalTitle.textContent = mode === 'edit' ? 'Edit Peminjam' : 'Input Peminjam';
      modalNo.value = data.no || '';
      document.getElementById('modalNim').value = data.nim || '';
      document.getElementById('modalNama').value = data.nama || '';
      document.getElementById('modalProdi').value = data.prodi || '';
      document.getElementById('modalTelepon').value = data.telepon || '';
      peminjamModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closePeminjamModal() {
      peminjamModal.classList.add('is-closing');
      setTimeout(() => {
        peminjamModal.setAttribute('aria-hidden', 'true');
        peminjamModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function renderRows(rows) {
      const body = document.getElementById('peminjamBody');
      body.innerHTML = '';
      rows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td align="left">${row.nim || ''}</td>
          <td align="left">${row.nama || ''}</td>
          <td align="left">${row.prodi || ''}</td>
          <td align="left">${row.telepon || ''}</td>
          <td>
            <span class="action-group">
              <a href="#" data-id="${row.no}" class="edit-link action-link action-icon" title="Edit" aria-label="Edit">
                <i class="fa-solid fa-user-pen"></i>
              </a>
              <a href="#" data-id="${row.no}" class="delete-link action-link action-link--danger action-icon" title="Hapus" aria-label="Hapus">
                <i class="fa-solid fa-user-xmark"></i>
              </a>
            </span>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    async function loadData() {
      const rows = await window.app.apiJson('/api/peminjam');
      renderRows(rows);
      $('#peminjamTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        dom: 'Bfrtip',
        buttons: [
          {
            extend: 'copyHtml5',
            text: '<i class="fa-regular fa-copy"></i> Copy'
          },
          {
            extend: 'excelHtml5',
            text: '<i class="fa-regular fa-file-excel"></i> Excel'
          },
          {
            extend: 'pdfHtml5',
            text: '<i class="fa-regular fa-file-pdf"></i> Unduh PDF',
            orientation: 'portrait',
            pageSize: 'A4',
            customize: function (doc) {
              doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
            },
            title: function () {
              return 'Laporan Data Peminjam';
            }
          }
        ]
      });
    }

    document.getElementById('openAddPeminjam').addEventListener('click', () => {
      openPeminjamModal('add');
    });

    peminjamModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closePeminjamModal();
      }
    });

    document.addEventListener('click', async (e) => {
      const editLink = e.target.closest('.edit-link');
      if (editLink) {
        e.preventDefault();
        const id = editLink.getAttribute('data-id');
        try {
          const data = await window.app.apiJson(`/api/peminjam?id=${id}`);
          openPeminjamModal('edit', data || {});
        } catch (err) {
          alert(err.message);
        }
      }
      const deleteLink = e.target.closest('.delete-link');
      if (deleteLink) {
        e.preventDefault();
        const id = deleteLink.getAttribute('data-id');
        if (!confirm('Anda yakin ingin menghapus data?')) return;
        try {
          await window.app.apiJson(`/api/peminjam?id=${id}`, { method: 'DELETE' });
          window.location.reload();
        } catch (err) {
          alert(err.message);
        }
      }
    });

    peminjamModalForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      peminjamModalAlert.innerHTML = '';
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());
      const id = modalNo.value;
      try {
        if (id) {
          await window.app.apiJson(`/api/peminjam?id=${id}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
        } else {
          await window.app.apiJson('/api/peminjam', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
        }
        closePeminjamModal();
        window.location.reload();
      } catch (err) {
        peminjamModalAlert.innerHTML = `<div class="alert alert-danger" role="alert">${err.message}</div>`;
      }
    });

    loadData().catch((err) => alert(err.message));
  </script>
</body>
</html>
