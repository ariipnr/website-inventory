<!DOCTYPE html>
<html>
<head>
  <title>Inventaris Barang</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page">
  <div class="crm-shell">
    <aside class="crm-sidebar">
      <a class="crm-brand crm-brand__link" href="index.html">
        <img src="image/LogoIPB.png" alt="Logo IPB">
        <div>
          <h2>Inventory CRM</h2>
          <span>Lab Komputer</span>
        </div>
      </a>
      <nav class="crm-nav">
        <a class="crm-nav__link" href="dashboard.html">Beranda</a>
        <a class="crm-nav__link" href="data_barang.html">Data Barang</a>
        <a class="crm-nav__link" href="data_peminjam.html">Data Peminjam</a>
        <a class="crm-nav__link active" href="pinjam_alat.html">Peminjaman</a>
        <a class="crm-nav__link" href="chart.html">Laporan</a>
        <a class="crm-nav__link" href="tentang_kami.html">Tentang Kami</a>
      </nav>
      <div class="crm-sidebar__footer">
        <span>Aktif sebagai</span>
        <strong id="username">-</strong>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="window.app.logout()">Logout</button>
      </div>
    </aside>

    <main class="crm-main">
      <header class="crm-topbar">
        <div>
          <h1>Peminjaman Alat</h1>
          <p>Kelola transaksi peminjaman dan pengembalian.</p>
        </div>
        <div class="crm-topbar__actions">
          <button class="btn btn-primary" id="openPinjamModal">Tambah Peminjaman</button>
        </div>
      </header>

      <section class="crm-panel">
        <h3>Ringkasan Peminjam Aktif</h3>
        <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th scope="col" align="left">NIM</th>
            <th scope="col" align="left">Nama</th>
            <th scope="col" align="left">Meminjam</th>
            <th scope="col" align="left">Terakhir Pinjam</th>
            <th scope="col" align="left">Aksi</th>
          </tr>
        </thead>
        <tbody id="borrowerSummaryBody"></tbody>
        </table>
      </section>

      <section class="crm-panel">
        <h3>Daftar Peminjam</h3>
        <table id="tdd" class="table table-hover table-striped">
        <thead>
          <tr>
            <th scope="col" align="left">Nim</th>
            <th scope="col" align="left">Nama</th>
            <th scope="col" align="left">Kode Alat</th>
            <th scope="col" align="left">Nama Alat</th>
            <th scope="col" align="left">Tanggal Peminjaman</th>
            <th scope="col" align="left">Tanggal Pengembalian</th>
            <th scope="col" align="left">Status</th>
            <th scope="col" align="left">Aksi</th>
          </tr>
        </thead>
        <tbody id="pinjamBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <div class="crm-modal" id="pinjamModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3>Form Peminjaman</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div id="pinjamAlert"></div>
      <form id="pinjamForm">
        <div class="form-group">
          <label>NIM</label>
          <select name="nim" id="nimSelect" class="form-control" required>
            <option value="">Pilih NIM</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nama</label>
          <input type="text" name="nama" id="namaInput" class="form-control" placeholder="Nama" required>
        </div>
        <div class="form-group">
          <label>Kode Alat</label>
          <select name="kode_alat" id="kodeSelect" class="form-control" required>
            <option value="">Pilih Kode Alat</option>
          </select>
          <small id="kodeInfo" class="form-text text-muted"></small>
        </div>
        <div class="form-group">
          <label>Tanggal Peminjaman</label>
          <input type="datetime-local" name="tgl_peminjaman" class="form-control" required>
        </div>
        <div class="crm-modal__actions">
          <button type="button" class="btn btn-light" data-close>Batal</button>
          <button class="btn btn-primary">Pinjam Alat</button>
        </div>
      </form>
    </div>
  </div>

  <div class="crm-modal" id="returnModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3>Pengembalian Alat</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div id="returnAlert"></div>
      <form id="returnForm">
        <input type="hidden" id="returnNo">
        <div class="form-group">
          <label>Tanggal Pengembalian</label>
          <input type="date" id="returnTanggal" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="returnStatus" class="form-control">
            <option value="Kembali">Kembali</option>
            <option value="Belum Kembali">Belum Kembali</option>
          </select>
        </div>
        <div class="crm-modal__actions">
          <button type="button" class="btn btn-light" data-close>Batal</button>
          <button class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="crm-modal" id="borrowerHistoryModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3 id="borrowerHistoryTitle">Riwayat Peminjam</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th align="left">Kode Alat</th>
              <th align="left">Nama Alat</th>
              <th align="left">Tanggal Pinjam</th>
              <th align="left">Tanggal Kembali</th>
              <th align="left">Status</th>
            </tr>
          </thead>
          <tbody id="borrowerHistoryBody"></tbody>
        </table>
      </div>
      <div class="crm-modal__actions">
        <button type="button" class="btn btn-light" data-close>Tutup</button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="app.js"></script>
  <script>
    window.app.requireAuth();
    (async () => {
      try {
        const data = await window.app.apiJson('/api/me');
        document.getElementById('username').textContent = data.username || '';
      } catch {
        document.getElementById('username').textContent = '';
      }
    })();

    const pinjamModal = document.getElementById('pinjamModal');
    const pinjamAlert = document.getElementById('pinjamAlert');
    const returnModal = document.getElementById('returnModal');
    const returnAlert = document.getElementById('returnAlert');
    const nimSelect = document.getElementById('nimSelect');
    const namaInput = document.getElementById('namaInput');
    const kodeSelect = document.getElementById('kodeSelect');
    const kodeInfo = document.getElementById('kodeInfo');
    const borrowerSummaryBody = document.getElementById('borrowerSummaryBody');
    const borrowerHistoryModal = document.getElementById('borrowerHistoryModal');
    const borrowerHistoryTitle = document.getElementById('borrowerHistoryTitle');
    const borrowerHistoryBody = document.getElementById('borrowerHistoryBody');

    let borrowerMap = {};
    let peminjamMap = {};
    let peminjamList = [];
    let barangMap = {};
    let pinjamByKode = {};

    function isActiveLoan(row) {
      const status = (row.status || '').toLowerCase();
      if (status === 'kembali') return false;
      if (row.tgl_pengembalian) return false;
      return true;
    }

    function openPinjamModal() {
      pinjamAlert.innerHTML = '';
      pinjamModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closePinjamModal() {
      pinjamModal.classList.add('is-closing');
      setTimeout(() => {
        pinjamModal.setAttribute('aria-hidden', 'true');
        pinjamModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function openReturnModal() {
      returnAlert.innerHTML = '';
      returnModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeReturnModal() {
      returnModal.classList.add('is-closing');
      setTimeout(() => {
        returnModal.setAttribute('aria-hidden', 'true');
        returnModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function openBorrowerHistory(nim) {
      const borrower = borrowerMap[nim] || {};
      borrowerHistoryTitle.textContent = `Riwayat: ${borrower.nama || ''} (${nim || ''})`;
      borrowerHistoryBody.innerHTML = '';
      const rows = (borrower.allRows || []).slice();
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="status-muted">Belum ada riwayat peminjaman.</td>`;
        borrowerHistoryBody.appendChild(tr);
      } else {
        rows.forEach((row) => {
          const statusClass = isActiveLoan(row) ? 'status-badge status-badge--borrowed' : 'status-badge status-badge--available';
          const statusLabel = isActiveLoan(row) ? 'Dipinjam' : 'Tersedia';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td align="left">${row.kode_alat || '-'}</td>
            <td align="left">${row.nama_alat || '-'}</td>
            <td align="left">${row.tgl_peminjaman || '-'}</td>
            <td align="left">${row.tgl_pengembalian || '-'}</td>
            <td align="left"><span class="${statusClass}">${statusLabel}</span></td>
          `;
          borrowerHistoryBody.appendChild(tr);
        });
      }
      borrowerHistoryModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeBorrowerHistory() {
      borrowerHistoryModal.classList.add('is-closing');
      setTimeout(() => {
        borrowerHistoryModal.setAttribute('aria-hidden', 'true');
        borrowerHistoryModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function renderBorrowerOptions() {
      const borrowers = (peminjamList || []).length
        ? peminjamList
        : Object.values(borrowerMap).filter((borrower) => borrower.nim);
      const sorted = borrowers.slice().sort((a, b) => (a.nama || '').localeCompare(b.nama || ''));
      nimSelect.innerHTML = '<option value="">Pilih NIM</option>';
      sorted.forEach((borrower) => {
        const option = document.createElement('option');
        option.value = borrower.nim || '';
        option.textContent = `${borrower.nim || '-'}${borrower.nama ? ` - ${borrower.nama}` : ''}`;
        nimSelect.appendChild(option);
      });
    }

    function renderKodeOptions() {
      const items = Object.values(barangMap).sort((a, b) => (a.kode_alat || '').localeCompare(b.kode_alat || ''));
      kodeSelect.innerHTML = '<option value="">Pilih Kode Alat</option>';
      items.forEach((item) => {
        const loans = pinjamByKode[item.kode_alat] || [];
        const activeCount = loans.filter((loan) => isActiveLoan(loan)).length;
        const jumlah = Number(item.jumlah) || 0;
        const tersedia = jumlah - activeCount;
        const option = document.createElement('option');
        option.value = item.kode_alat || '';
        option.dataset.nama = item.nama_alat || '';
        option.dataset.tersedia = String(tersedia);
        option.textContent = `${item.kode_alat || '-'}${item.nama_alat ? ` - ${item.nama_alat}` : ''} (Sisa ${tersedia})`;
        if (tersedia <= 0) {
          option.disabled = true;
        }
        kodeSelect.appendChild(option);
      });
    }

    document.getElementById('openPinjamModal').addEventListener('click', openPinjamModal);
    pinjamModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closePinjamModal();
      }
    });

    returnModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closeReturnModal();
      }
    });

    borrowerHistoryModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closeBorrowerHistory();
      }
    });

    nimSelect.addEventListener('change', () => {
      const nim = nimSelect.value;
      const peminjam = peminjamMap[nim];
      const fallback = borrowerMap[nim];
      if (peminjam && peminjam.nama) {
        namaInput.value = peminjam.nama;
      } else if (fallback && fallback.nama) {
        namaInput.value = fallback.nama;
      } else if (!nim) {
        namaInput.value = '';
      }
    });

    kodeSelect.addEventListener('change', () => {
      const selected = kodeSelect.options[kodeSelect.selectedIndex];
      if (!selected || !selected.value) {
        kodeInfo.textContent = '';
        return;
      }
      const namaAlat = selected.dataset.nama || '';
      const tersedia = selected.dataset.tersedia || '';
      kodeInfo.textContent = `${namaAlat ? `Nama: ${namaAlat}. ` : ''}Ketersediaan: ${tersedia}`;
    });

    function renderRows(rows) {
      window.currentPinjam = rows;
      const body = document.getElementById('pinjamBody');
      body.innerHTML = '';
      rows.forEach((row) => {
        const statusClass = isActiveLoan(row) ? 'status-badge status-badge--borrowed' : 'status-badge status-badge--available';
        const statusLabel = isActiveLoan(row) ? 'Dipinjam' : 'Tersedia';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td align="left">${row.nim || ''}</td>
          <td align="left">${row.nama || ''}</td>
          <td align="left">${row.kode_alat || ''}</td>
          <td align="left">${row.nama_alat || ''}</td>
          <td align="left">${row.tgl_peminjaman || ''}</td>
          <td align="left">${row.tgl_pengembalian || ''}</td>
          <td align="left"><span class="${statusClass}">${statusLabel}</span></td>
          <td>
            <a href="#" data-id="${row.no}" class="return-pinjam">Kembalikan</a> |
            <a href="#" data-id="${row.no}" class="delete-pinjam">Hapus</a>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function renderBorrowerSummary(rows) {
      borrowerSummaryBody.innerHTML = '';
      borrowerMap = rows.reduce((acc, row) => {
        const key = row.nim || 'unknown';
        if (!acc[key]) {
          acc[key] = { nim: row.nim, nama: row.nama, activeItems: [], allRows: [] };
        }
        acc[key].allRows.push(row);
        if (!acc[key].nama && row.nama) {
          acc[key].nama = row.nama;
        }
        if (isActiveLoan(row)) {
          acc[key].activeItems.push(`${row.kode_alat || '-'}${row.nama_alat ? ` - ${row.nama_alat}` : ''}`);
        }
        return acc;
      }, {});

      Object.values(borrowerMap)
        .sort((a, b) => (a.nama || '').localeCompare(b.nama || ''))
        .forEach((borrower) => {
          const activeItems = borrower.activeItems.length ? borrower.activeItems.join(', ') : '-';
          const lastRow = borrower.allRows.slice().sort((a, b) => {
            const aDate = a.tgl_peminjaman || '';
            const bDate = b.tgl_peminjaman || '';
            if (aDate === bDate) return Number(b.no) - Number(a.no);
            return aDate < bDate ? 1 : -1;
          })[0];
          const lastDate = lastRow && lastRow.tgl_peminjaman ? lastRow.tgl_peminjaman : '-';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td align="left">${borrower.nim || '-'}</td>
            <td align="left">${borrower.nama || '-'}</td>
            <td align="left">${activeItems}</td>
            <td align="left">${lastDate}</td>
            <td><a href="#" data-nim="${borrower.nim || ''}" class="borrower-history">Riwayat</a></td>
          `;
          borrowerSummaryBody.appendChild(tr);
        });
    }

    async function loadData() {
      const [rows, barang, peminjam] = await Promise.all([
        window.app.apiJson('/api/peminjaman'),
        window.app.apiJson('/api/barang'),
        window.app.apiJson('/api/peminjam')
      ]);
      peminjamList = peminjam || [];
      peminjamMap = (peminjam || []).reduce((acc, row) => {
        if (row.nim) acc[row.nim] = row;
        return acc;
      }, {});
      barangMap = (barang || []).reduce((acc, row) => {
        acc[row.kode_alat] = row;
        return acc;
      }, {});
      pinjamByKode = (rows || []).reduce((acc, row) => {
        const key = row.kode_alat || 'unknown';
        if (!acc[key]) acc[key] = [];
        acc[key].push(row);
        return acc;
      }, {});
      renderRows(rows);
      renderBorrowerSummary(rows);
      renderBorrowerOptions();
      renderKodeOptions();
      $('#tdd').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        dom: 'Bfrtp',
        buttons: [
          'excelHtml5',
          {
            extend: 'pdfHtml5',
            text: 'Unduh PDF',
            orientation: 'portrait',
            pageSize: 'A4',
            customize: function (doc) {
              doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
            },
            title: function () {
              return 'Laporan Data Peminjaman Alat';
            }
          }
        ]
      });
    }

    document.getElementById('pinjamForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      pinjamAlert.innerHTML = '';
      if (kodeSelect.options[kodeSelect.selectedIndex] && kodeSelect.options[kodeSelect.selectedIndex].disabled) {
        pinjamAlert.innerHTML = '<div class="alert alert-danger" role="alert">Barang tidak tersedia.</div>';
        return;
      }
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());
      try {
        await window.app.apiJson('/api/peminjaman', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        closePinjamModal();
        e.target.reset();
        window.location.reload();
      } catch (err) {
        pinjamAlert.innerHTML = `<div class="alert alert-danger" role="alert">${err.message}</div>`;
      }
    });

    document.getElementById('returnForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      returnAlert.innerHTML = '';
      const id = document.getElementById('returnNo').value;
      const tgl_pengembalian = document.getElementById('returnTanggal').value;
      const status = document.getElementById('returnStatus').value;
      try {
        await window.app.apiJson(`/api/peminjaman?id=${id}`, {
          method: 'PUT',
          body: JSON.stringify({ tgl_pengembalian, status })
        });
        closeReturnModal();
        window.location.reload();
      } catch (err) {
        returnAlert.innerHTML = `<div class="alert alert-danger" role="alert">${err.message}</div>`;
      }
    });

    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('return-pinjam')) {
        e.preventDefault();
        const id = e.target.getAttribute('data-id');
        const row = (window.currentPinjam || []).find((r) => String(r.no) === String(id));
        document.getElementById('returnNo').value = id;
        document.getElementById('returnTanggal').value = row && row.tgl_pengembalian ? row.tgl_pengembalian : '';
        document.getElementById('returnStatus').value = row && row.status ? row.status : 'Kembali';
        openReturnModal();
        return;
      }
      if (e.target.classList.contains('delete-pinjam')) {
        e.preventDefault();
        const id = e.target.getAttribute('data-id');
        if (!confirm('Anda yakin ingin menghapus data?')) return;
        try {
          await window.app.apiJson(`/api/peminjaman?id=${id}`, { method: 'DELETE' });
          window.location.reload();
        } catch (err) {
          alert(err.message);
        }
      }
      if (e.target.classList.contains('borrower-history')) {
        e.preventDefault();
        const nim = e.target.getAttribute('data-nim');
        openBorrowerHistory(nim);
      }
    });

    loadData().catch((err) => alert(err.message));
  </script>
</body>
</html>
