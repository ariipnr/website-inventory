<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Inventaris</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard-page">
  <div class="crm-shell">
    <aside class="crm-sidebar">
      <a class="crm-brand crm-brand__link" href="index.html">
        <img src="image/LogoIPB.png" alt="Logo IPB">
        <div>
          <h2>Inventory CRM</h2>
          <span>Lab Komputer</span>
        </div>
      </a>
      <nav class="crm-nav">
        <a class="crm-nav__link active" href="dashboard.html">Beranda</a>
        <a class="crm-nav__link" href="data_barang.html">Data Barang</a>
        <a class="crm-nav__link" href="pinjam_alat.html">Peminjaman</a>
        <a class="crm-nav__link" href="chart.html">Laporan</a>
        <a class="crm-nav__link" href="tentang_kami.html">Tentang Kami</a>
      </nav>
      <div class="crm-sidebar__footer">
        <span>Aktif sebagai</span>
        <strong id="username">-</strong>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="window.app.logout()">Logout</button>
      </div>
    </aside>

    <main class="crm-main">
      <header class="crm-topbar">
        <div>
          <h1>Ringkasan Dashboard</h1>
          <p>Kelola inventaris, peminjaman, dan laporan lab komputer.</p>
        </div>
        <div class="crm-topbar__actions">
          <button class="btn btn-primary" id="openInputModal">Tambah Barang</button>
        </div>
      </header>

      <section class="crm-stats">
        <div class="crm-card">
          <h3>Total Barang</h3>
          <span class="crm-card__value" id="statTotal">-</span>
          <small>Data terkini dari inventaris.</small>
        </div>
        <div class="crm-card">
          <h3>Kategori Aktif</h3>
          <span class="crm-card__value" id="statKategori">-</span>
          <small>Jumlah kategori barang.</small>
        </div>
        <div class="crm-card">
          <h3>Peminjaman</h3>
          <span class="crm-card__value" id="statPinjam">-</span>
          <small>Transaksi peminjaman terbaru.</small>
        </div>
      </section>

      <section class="crm-filters">
        <div class="crm-filter">
          <label for="filterKategori">Filter Kategori</label>
          <select id="filterKategori" class="form-control">
            <option value="">Semua Kategori</option>
          </select>
        </div>
        <div class="crm-filter">
          <label for="filterStatus">Status Peminjaman</label>
          <select id="filterStatus" class="form-control">
            <option value="">Semua Status</option>
            <option value="Belum Kembali">Belum Kembali</option>
            <option value="Kembali">Kembali</option>
          </select>
        </div>
        <button class="btn btn-outline-primary crm-filter__apply" id="applyFilter">Terapkan</button>
        <button class="btn btn-light crm-filter__reset" id="resetFilter">Reset</button>
      </section>

      <section class="crm-panels">
        <div class="crm-panel">
          <h3>Grafik Kategori Barang</h3>
          <canvas id="kategoriChart" height="160"></canvas>
        </div>
        <div class="crm-panel">
          <h3>Akses Cepat</h3>
          <div class="crm-quick">
            <a href="data_barang.html">Lihat Data Barang</a>
            <a href="#" id="quickInputBarang">Input Barang Baru</a>
            <a href="pinjam_alat.html">Kelola Peminjaman</a>
            <a href="chart.html">Laporan & Grafik</a>
          </div>
        </div>
      </section>

      <section class="crm-panels">
        <div class="crm-panel crm-panel--accent">
          <h3>Catatan Harian</h3>
          <p>Pastikan data peminjaman diperbarui agar laporan tetap akurat.</p>
          <button class="btn btn-light btn-sm" onclick="window.location.href='pinjam_alat.html'">Cek Peminjaman</button>
        </div>
        <div class="crm-panel crm-panel--accent-light">
          <h3>Ringkasan Filter</h3>
          <p id="filterSummary">Menampilkan semua data tanpa filter.</p>
        </div>
      </section>
    </main>
  </div>

  <div class="crm-modal" id="inputModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3>Input Barang Baru</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div id="modalAlert"></div>
      <form id="modalInputForm">
        <div class="form-group">
          <label>Kode Alat</label>
          <input type="text" name="kd_alat" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select name="kategori" class="form-control" required>
            <option value="Network Device">Network Device</option>
            <option value="PC">PC</option>
            <option value="Sparepart">Sparepart</option>
            <option value="Printer">Printer</option>
            <option value="Alat">Alat</option>
            <option value="Lainnya">Lainnya</option>
          </select>
        </div>
        <div class="form-group">
          <label>Merek</label>
          <input type="text" name="merek" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Nama Alat</label>
          <input type="text" name="nama_alat" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Spesifikasi</label>
          <textarea name="spek" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Jumlah</label>
          <input type="number" name="jml" class="form-control" min="0" required>
        </div>
        <div class="crm-modal__actions">
          <button type="button" class="btn btn-light" data-close>Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="app.js"></script>
  <script>
    window.app.requireAuth();

    let rawBarang = [];
    let rawPinjam = [];
    let chart;
    const inputModal = document.getElementById('inputModal');
    const modalAlert = document.getElementById('modalAlert');

    function openModal() {
      inputModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeModal() {
      inputModal.classList.add('is-closing');
      setTimeout(() => {
        inputModal.setAttribute('aria-hidden', 'true');
        inputModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function setStats(barang, pinjam) {
      const kategoriSet = new Set((barang || []).map((row) => row.kategori).filter(Boolean));
      document.getElementById('statTotal').textContent = (barang || []).length;
      document.getElementById('statKategori').textContent = kategoriSet.size;
      document.getElementById('statPinjam').textContent = (pinjam || []).length;
    }

    function buildKategoriOptions(barang) {
      const select = document.getElementById('filterKategori');
      const categories = Array.from(new Set((barang || []).map((row) => row.kategori).filter(Boolean)));
      categories.sort();
      categories.forEach((c) => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
    }

    function updateChart(filteredBarang) {
      const map = {};
      (filteredBarang || []).forEach((row) => {
        const key = row.kategori || 'Lainnya';
        map[key] = (map[key] || 0) + 1;
      });
      const labels = Object.keys(map);
      const values = Object.values(map);

      if (!chart) {
        const ctx = document.getElementById('kategoriChart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'Jumlah Barang',
                data: values,
                backgroundColor: 'rgba(13, 59, 120, 0.7)',
                borderRadius: 8
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true }
            }
          }
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.update();
      }
    }

    function applyFilters() {
      const kategori = document.getElementById('filterKategori').value;
      const status = document.getElementById('filterStatus').value;

      const filteredBarang = kategori
        ? rawBarang.filter((row) => row.kategori === kategori)
        : rawBarang.slice();
      const filteredPinjam = status
        ? rawPinjam.filter((row) => row.status === status)
        : rawPinjam.slice();

      setStats(filteredBarang, filteredPinjam);
      updateChart(filteredBarang);

      const summary = [];
      if (kategori) summary.push(`Kategori: ${kategori}`);
      if (status) summary.push(`Status: ${status}`);
      document.getElementById('filterSummary').textContent =
        summary.length ? `Filter aktif: ${summary.join(', ')}` : 'Menampilkan semua data tanpa filter.';
    }

    document.getElementById('applyFilter').addEventListener('click', applyFilters);
    document.getElementById('resetFilter').addEventListener('click', () => {
      document.getElementById('filterKategori').value = '';
      document.getElementById('filterStatus').value = '';
      applyFilters();
    });

    document.getElementById('openInputModal').addEventListener('click', openModal);
    document.getElementById('quickInputBarang').addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
    inputModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closeModal();
      }
    });

    document.getElementById('modalInputForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      modalAlert.innerHTML = '';
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());
      try {
        await window.app.apiJson('/api/barang', {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        closeModal();
        e.target.reset();
        rawBarang = await window.app.apiJson('/api/barang');
        rawPinjam = await window.app.apiJson('/api/peminjaman');
        buildKategoriOptions(rawBarang);
        setStats(rawBarang, rawPinjam);
        updateChart(rawBarang);
      } catch (err) {
        modalAlert.innerHTML = `<div class="alert alert-danger" role="alert">${err.message}</div>`;
      }
    });

    (async () => {
      try {
        const data = await window.app.apiJson('/api/me');
        document.getElementById('username').textContent = data.username || '';
      } catch {
        document.getElementById('username').textContent = '';
      }
    })();

    (async () => {
      try {
        rawBarang = await window.app.apiJson('/api/barang');
        rawPinjam = await window.app.apiJson('/api/peminjaman');
        buildKategoriOptions(rawBarang);
        setStats(rawBarang, rawPinjam);
        updateChart(rawBarang);
      } catch {
        document.getElementById('statTotal').textContent = '-';
        document.getElementById('statKategori').textContent = '-';
        document.getElementById('statPinjam').textContent = '-';
      }
    })();
  </script>
</body>
</html>
