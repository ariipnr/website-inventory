<!DOCTYPE html>
<html>
<head>
  <title>Inventaris Barang</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-page">
  <div class="crm-shell">
    <aside class="crm-sidebar">
      <a class="crm-brand crm-brand__link" href="index.html">
        <img src="image/LogoIPB.png" alt="Logo IPB">
        <div>
          <h2>Inventory CRM</h2>
          <span>Lab Komputer</span>
        </div>
      </a>
      <nav class="crm-nav">
        <a class="crm-nav__link" href="dashboard.html">Beranda</a>
        <a class="crm-nav__link active" href="data_barang.html">Data Barang</a>
        <a class="crm-nav__link" href="data_peminjam.html">Data Peminjam</a>
        <a class="crm-nav__link" href="pinjam_alat.html">Peminjaman</a>
        <a class="crm-nav__link" href="chart.html">Laporan</a>
        <a class="crm-nav__link" href="tentang_kami.html">Tentang Kami</a>
      </nav>
      <div class="crm-sidebar__footer">
        <span>Aktif sebagai</span>
        <strong id="username">-</strong>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="window.app.logout()">Logout</button>
      </div>
    </aside>

    <main class="crm-main">
      <header class="crm-topbar">
        <div>
          <h1>Data Barang</h1>
          <p>Kelola daftar inventaris barang lab komputer.</p>
        </div>
        <div class="crm-topbar__actions">
          <button class="btn btn-primary" id="openAddBarang">Tambah Barang</button>
        </div>
      </header>

      <section class="crm-panel">
        <table id="tdd" class="table table-hover table-striped">
        <thead>
          <tr>
            <th scope="col" align="left">Kode Alat</th>
            <th scope="col" align="left">Serial Number</th>
            <th scope="col" align="left">Kategori</th>
            <th scope="col" align="left">Merek</th>
            <th scope="col" align="left">Nama Alat</th>
            <th scope="col" align="left">Spesifikasi</th>
            <th scope="col" align="left">Jumlah</th>
            <th scope="col" align="left">Status</th>
            <th scope="col" align="left">Dipinjam Oleh</th>
            <th scope="col" align="left">Aksi</th>
          </tr>
        </thead>
        <tbody id="barangBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <div class="crm-modal" id="barangModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3 id="barangModalTitle">Input Barang</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div id="barangModalAlert"></div>
      <form id="barangModalForm">
        <input type="hidden" name="no" id="modalNo">
        <div class="form-group">
          <label>Kode Alat</label>
          <input type="text" name="kd_alat" id="modalKode" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Serial Number</label>
          <input type="text" name="serial_number" id="modalSerial" class="form-control" placeholder="Serial Number">
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select name="kategori" id="modalKategori" class="form-control" required>
            <option value="Network Device">Network Device</option>
            <option value="PC">PC</option>
            <option value="Sparepart">Sparepart</option>
            <option value="Printer">Printer</option>
            <option value="Alat">Alat</option>
            <option value="Lainnya">Lainnya</option>
          </select>
        </div>
        <div class="form-group">
          <label>Merek</label>
          <input type="text" name="merek" id="modalMerek" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Nama Alat</label>
          <input type="text" name="nama_alat" id="modalNama" class="form-control" required>
        </div>
        <div class="form-group">
          <label>Spesifikasi</label>
          <textarea name="spek" id="modalSpek" class="form-control" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Jumlah</label>
          <input type="number" name="jml" id="modalJumlah" class="form-control" min="0" required>
        </div>
        <div class="crm-modal__actions">
          <button type="button" class="btn btn-light" data-close>Batal</button>
          <button type="submit" class="btn btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="crm-modal" id="barangHistoryModal" aria-hidden="true">
    <div class="crm-modal__backdrop" data-close></div>
    <div class="crm-modal__content" role="dialog" aria-modal="true">
      <div class="crm-modal__header">
        <h3 id="barangHistoryTitle">Riwayat Peminjaman Barang</h3>
        <button class="crm-modal__close" type="button" data-close>&times;</button>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-striped">
          <thead>
            <tr>
              <th align="left">NIM</th>
              <th align="left">Nama</th>
              <th align="left">Tanggal Pinjam</th>
              <th align="left">Tanggal Kembali</th>
              <th align="left">Status</th>
            </tr>
          </thead>
          <tbody id="barangHistoryBody"></tbody>
        </table>
      </div>
      <div class="crm-modal__actions">
        <button type="button" class="btn btn-light" data-close>Tutup</button>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="app.js"></script>
  <script>
    window.app.requireAuth();
    (async () => {
      try {
        const data = await window.app.apiJson('/api/me');
        document.getElementById('username').textContent = data.username || '';
      } catch {
        document.getElementById('username').textContent = '';
      }
    })();

    const barangModal = document.getElementById('barangModal');
    const barangModalAlert = document.getElementById('barangModalAlert');
    const barangModalTitle = document.getElementById('barangModalTitle');
    const barangModalForm = document.getElementById('barangModalForm');
    const modalNo = document.getElementById('modalNo');
    const modalSerial = document.getElementById('modalSerial');
    const barangHistoryModal = document.getElementById('barangHistoryModal');
    const barangHistoryTitle = document.getElementById('barangHistoryTitle');
    const barangHistoryBody = document.getElementById('barangHistoryBody');

    let barangRows = [];
    let peminjamanRows = [];
    let barangMap = {};
    let pinjamByKode = {};

    function isActiveLoan(row) {
      const status = (row.status || '').toLowerCase();
      if (status === 'kembali') return false;
      if (row.tgl_pengembalian) return false;
      return true;
    }

    function openBarangModal(mode, data = {}) {
      barangModalAlert.innerHTML = '';
      barangModalTitle.textContent = mode === 'edit' ? 'Edit Barang' : 'Input Barang';
      modalNo.value = data.no || '';
      document.getElementById('modalKode').value = data.kode_alat || '';
      modalSerial.value = data.serial_number || '';
      document.getElementById('modalKategori').value = data.kategori || 'Network Device';
      document.getElementById('modalMerek').value = data.merek || '';
      document.getElementById('modalNama').value = data.nama_alat || '';
      document.getElementById('modalSpek').value = data.spesifikasi || '';
      document.getElementById('modalJumlah').value = data.jumlah || '';
      barangModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeBarangModal() {
      barangModal.classList.add('is-closing');
      setTimeout(() => {
        barangModal.setAttribute('aria-hidden', 'true');
        barangModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function openBarangHistory(kode) {
      const item = barangMap[kode] || {};
      barangHistoryTitle.textContent = `Riwayat Peminjaman: ${item.nama_alat || kode || ''}`;
      const rows = (pinjamByKode[kode] || []).slice();
      barangHistoryBody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="status-muted">Belum ada riwayat peminjaman.</td>`;
        barangHistoryBody.appendChild(tr);
      } else {
        rows.forEach((row) => {
          const tr = document.createElement('tr');
          const statusClass = isActiveLoan(row) ? 'status-badge status-badge--borrowed' : 'status-badge status-badge--available';
          const statusLabel = isActiveLoan(row) ? 'Dipinjam' : 'Tersedia';
          tr.innerHTML = `
            <td align="left">${row.nim || '-'}</td>
            <td align="left">${row.nama || '-'}</td>
            <td align="left">${row.tgl_peminjaman || '-'}</td>
            <td align="left">${row.tgl_pengembalian || '-'}</td>
            <td align="left"><span class="${statusClass}">${statusLabel}</span></td>
          `;
          barangHistoryBody.appendChild(tr);
        });
      }
      barangHistoryModal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('modal-open');
    }

    function closeBarangHistory() {
      barangHistoryModal.classList.add('is-closing');
      setTimeout(() => {
        barangHistoryModal.setAttribute('aria-hidden', 'true');
        barangHistoryModal.classList.remove('is-closing');
        document.body.classList.remove('modal-open');
      }, 180);
    }

    function renderRows(rows) {
      const body = document.getElementById('barangBody');
      body.innerHTML = '';
      rows.forEach((row) => {
        const loans = pinjamByKode[row.kode_alat] || [];
        const activeLoan = loans.find((loan) => isActiveLoan(loan));
        const statusClass = activeLoan ? 'status-badge status-badge--borrowed' : 'status-badge status-badge--available';
        const statusLabel = activeLoan ? 'Dipinjam' : 'Tersedia';
        const borrower = activeLoan ? `${activeLoan.nim || '-'}${activeLoan.nama ? ` - ${activeLoan.nama}` : ''}` : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td align="left">${row.kode_alat || ''}</td>
          <td align="left">${row.serial_number || ''}</td>
          <td align="left">${row.kategori || ''}</td>
          <td align="left">${row.merek || ''}</td>
          <td align="left">${row.nama_alat || ''}</td>
          <td align="left">${row.spesifikasi || ''}</td>
          <td align="left">${row.jumlah || ''}</td>
          <td align="left"><span class="${statusClass}">${statusLabel}</span></td>
          <td align="left">${borrower}</td>
          <td>
            <a href="#" data-id="${row.no}" class="edit-link">Edit</a> |
            <a href="#" data-id="${row.no}" class="delete-link">Delete</a> |
            <a href="#" data-kode="${row.kode_alat || ''}" class="history-link">Riwayat</a> |
            <a href="generate_barcode.html?no=${row.no}">Generate</a>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    async function loadData() {
      const [barang, peminjaman] = await Promise.all([
        window.app.apiJson('/api/barang'),
        window.app.apiJson('/api/peminjaman')
      ]);
      barangRows = barang || [];
      peminjamanRows = peminjaman || [];
      barangMap = barangRows.reduce((acc, row) => {
        acc[row.kode_alat] = row;
        return acc;
      }, {});
      pinjamByKode = peminjamanRows
        .slice()
        .sort((a, b) => {
          const aDate = a.tgl_peminjaman || '';
          const bDate = b.tgl_peminjaman || '';
          if (aDate === bDate) return Number(b.no) - Number(a.no);
          return aDate < bDate ? 1 : -1;
        })
        .reduce((acc, row) => {
          const key = row.kode_alat || 'unknown';
          if (!acc[key]) acc[key] = [];
          acc[key].push(row);
          return acc;
        }, {});
      renderRows(barangRows);
      $('#tdd').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        dom: 'Bfrtip',
        buttons: [
          'copyHtml5',
          'excelHtml5',
          {
            extend: 'pdfHtml5',
            text: 'Unduh PDF',
            orientation: 'portrait',
            pageSize: 'A4',
            customize: function (doc) {
              doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
            },
            title: function () {
              return 'Laporan Data Barang Inventaris Lab Komputer';
            }
          }
        ]
      });
    }

    document.getElementById('openAddBarang').addEventListener('click', () => {
      openBarangModal('add');
    });

    barangModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closeBarangModal();
      }
    });

    barangHistoryModal.addEventListener('click', (e) => {
      if (e.target.hasAttribute('data-close')) {
        closeBarangHistory();
      }
    });

    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('edit-link')) {
        e.preventDefault();
        const id = e.target.getAttribute('data-id');
        try {
          const data = await window.app.apiJson(`/api/barang?id=${id}`);
          openBarangModal('edit', data || {});
        } catch (err) {
          alert(err.message);
        }
      }
      if (e.target.classList.contains('delete-link')) {
        e.preventDefault();
        const id = e.target.getAttribute('data-id');
        if (!confirm('Anda yakin ingin menghapus data?')) return;
        try {
          await window.app.apiJson(`/api/barang?id=${id}`, { method: 'DELETE' });
          window.location.reload();
        } catch (err) {
          alert(err.message);
        }
      }
      if (e.target.classList.contains('history-link')) {
        e.preventDefault();
        const kode = e.target.getAttribute('data-kode');
        openBarangHistory(kode);
      }
    });

    barangModalForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      barangModalAlert.innerHTML = '';
      const formData = new FormData(e.target);
      const payload = Object.fromEntries(formData.entries());
      const id = modalNo.value;
      try {
        if (id) {
          await window.app.apiJson(`/api/barang?id=${id}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
          });
        } else {
          await window.app.apiJson('/api/barang', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
        }
        closeBarangModal();
        window.location.reload();
      } catch (err) {
        barangModalAlert.innerHTML = `<div class="alert alert-danger" role="alert">${err.message}</div>`;
      }
    });

    loadData().catch((err) => alert(err.message));
  </script>
</body>
</html>
